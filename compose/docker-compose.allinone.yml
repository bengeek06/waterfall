services:
  waterfall-app:
    build: 
      context: ..
      dockerfile: Dockerfile.allinone
    container_name: waterfall-app
    ports:
      - "80:80"
      - "443:443"
      # Port PostgreSQL (optionnel, pour accès externe)
      - "5432:5432"
    environment:
      # Secrets personnalisables (optionnel - générés automatiquement si non fournis)
      JWT_SECRET: ${JWT_SECRET:-}
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN:-}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-}
      
      # Variables d'environnement optionnelles pour les APIs
      FLASK_ENV: ${FLASK_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # Configuration Next.js
      NODE_ENV: ${NODE_ENV:-production}
      
    volumes:
      # Persistance des données PostgreSQL
      - postgres_data:/app/data/postgres
      
      # Persistance des secrets (recommandé pour éviter la régénération)
      - waterfall_secrets:/app/secrets
      
      # Persistance des logs (optionnel)
      - waterfall_logs:/app/logs
      
      # Certificats SSL (optionnel, pour utiliser ses propres certificats)
      # - ./ssl/server.crt:/etc/ssl/waterfall/server.crt:ro
      # - ./ssl/server.key:/etc/ssl/waterfall/server.key:ro
      
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Limites de ressources (optionnel)
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.25'

volumes:
  postgres_data:
    driver: local
  waterfall_secrets:
    driver: local
  waterfall_logs:
    driver: local

# Configuration réseau (optionnel)
# networks:
#   waterfall:
#     driver: bridge