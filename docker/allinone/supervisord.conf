[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
user=root

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# PostgreSQL is already started in entrypoint.sh, no need to manage it here

# ==============================================================================
# Auth Service
# ==============================================================================
[program:auth-service]
command=python3 -m gunicorn --config gunicorn.conf.py wsgi:app
directory=/app/auth_service
user=root
autostart=true
autorestart=true
priority=200
environment=FLASK_ENV="%(ENV_FLASK_ENV)s",DATABASE_URL="%(ENV_DATABASE_URL_AUTH)s",JWT_SECRET="%(ENV_JWT_SECRET)s",INTERNAL_AUTH_TOKEN="%(ENV_INTERNAL_AUTH_TOKEN)s",USER_SERVICE_URL="%(ENV_IDENTITY_SERVICE_URL)s",APP_MODE="production",LOG_LEVEL="%(ENV_LOG_LEVEL)s"
stdout_logfile=/app/logs/auth.log
stderr_logfile=/app/logs/auth_error.log

# ==============================================================================
# Identity Service
# ==============================================================================
[program:identity-service]
command=python3 -m gunicorn --config gunicorn.conf.py wsgi:app
directory=/app/identity_service
user=root
autostart=true
autorestart=true
priority=200
environment=FLASK_ENV="%(ENV_FLASK_ENV)s",DATABASE_URL="%(ENV_DATABASE_URL_IDENTITY)s",JWT_SECRET="%(ENV_JWT_SECRET)s",INTERNAL_AUTH_TOKEN="%(ENV_INTERNAL_AUTH_TOKEN)s",GUARDIAN_SERVICE_URL="%(ENV_GUARDIAN_SERVICE_URL)s",APP_MODE="production",LOG_LEVEL="%(ENV_LOG_LEVEL)s"
stdout_logfile=/app/logs/identity.log
stderr_logfile=/app/logs/identity_error.log

# ==============================================================================
# Guardian Service
# ==============================================================================
[program:guardian-service]
command=python3 -m gunicorn --config gunicorn.conf.py wsgi:app
directory=/app/guardian_service
user=root
autostart=true
autorestart=true
priority=200
environment=FLASK_ENV="%(ENV_FLASK_ENV)s",DATABASE_URL="%(ENV_DATABASE_URL_GUARDIAN)s",JWT_SECRET="%(ENV_JWT_SECRET)s",APP_MODE="production",LOG_LEVEL="%(ENV_LOG_LEVEL)s"
stdout_logfile=/app/logs/guardian.log
stderr_logfile=/app/logs/guardian_error.log

# ==============================================================================
# Web Service (Next.js)
# ==============================================================================
[program:web-service]
command=node server.js
directory=/app/web
user=root
autostart=true
autorestart=true
priority=200
environment=NODE_ENV="production",AUTH_SERVICE_URL="%(ENV_AUTH_SERVICE_URL)s",IDENTITY_SERVICE_URL="%(ENV_IDENTITY_SERVICE_URL)s",GUARDIAN_SERVICE_URL="%(ENV_GUARDIAN_SERVICE_URL)s"
stdout_logfile=/app/logs/web.log
stderr_logfile=/app/logs/web_error.log

# ==============================================================================
# Nginx Reverse Proxy
# ==============================================================================
[program:nginx]
command=nginx -g "daemon off;"
autostart=true
autorestart=true
priority=300
stdout_logfile=/app/logs/nginx.log
stderr_logfile=/app/logs/nginx_error.log
